{"name":"seAdapter01 V1.0","type":"com.fibaro.energyMeter","apiVersion":"1.2","initialProperties":{"viewLayout":{"$jason":{"body":{"header":{"style":{"height":"0"},"title":"quickApp_device_605"},"sections":{"items":[{"components":[{"name":"LME","style":{"weight":"1.2"},"text":"timestamp","type":"label"},{"style":{"weight":"0.5"},"type":"space"}],"style":{"weight":"1.2"},"type":"vertical"},{"components":[{"name":"CPE","style":{"weight":"1.2"},"text":"power aktuell","type":"label"},{"style":{"weight":"0.5"},"type":"space"}],"style":{"weight":"1.2"},"type":"vertical"},{"components":[{"name":"TPE","style":{"weight":"1.2"},"text":"energy day","type":"label"},{"style":{"weight":"0.5"},"type":"space"}],"style":{"weight":"1.2"},"type":"vertical"},{"components":[{"name":"MPE","style":{"weight":"1.2"},"text":"energy month","type":"label"},{"style":{"weight":"0.5"},"type":"space"}],"style":{"weight":"1.2"},"type":"vertical"},{"components":[{"name":"YPE","style":{"weight":"1.2"},"text":"energy year","type":"label"},{"style":{"weight":"0.5"},"type":"space"}],"style":{"weight":"1.2"},"type":"vertical"},{"components":[{"name":"LTE","style":{"weight":"1.2"},"text":"energy lifetime","type":"label"},{"style":{"weight":"0.5"},"type":"space"}],"style":{"weight":"1.2"},"type":"vertical"},{"components":[{"name":"LTM","style":{"weight":"1.2"},"text":"money lifetime","type":"label"},{"style":{"weight":"0.5"},"type":"space"}],"style":{"weight":"1.2"},"type":"vertical"}]}},"head":{"title":"quickApp_device_605"}}},"uiCallbacks":[],"quickAppVariables":[{"name":"site_id","value":"388617"},{"name":"api_key","value":"3FQL8LLIBWXAWB61F8UF0LFWVDW420FB"},{"name":"wait","value":"no"},{"name":"globalvalues","value":"yes"},{"name":"interval","value":"600"}],"typeTemplateInitialized":true},"files":[{"name":"main","isMain":true,"isOpen":true,"content":"-- seAdpater1 V1.0\n-- Adapter für SolarEdge-Wechselrichter zur Anzeige von Livedaten aus dem SolarEdge-Portal, QuickApp für Fibaro HC3\n-- Der Adapter fragt ausgewählte Daten des SolarEdge-Wechselrichters zyklisch ab und stellt diese \n-- in einer Übersicht zur Verfügung.\n\n-- Copyright (C) 2020, Thomas Burchert, 10Consult, Germany\n\n-- GNU General Public License (Dieses Programm ist freie Software. Sie können es unter den Bedingungen der GNU General Public License, wie von der Free Software Foundation veröffentlicht, weitergeben und/oder modifizieren, entweder gemäß Version 3 der Lizenz oder (nach Ihrer Wahl) gemäß jeder späteren Version. Die Veröffentlichung dieses Programms erfolgt in der Hoffnung, daß es Ihnen von Nutzen sein wird, aber OHNE IRGENDEINE GARANTIE, sogar ohne die implizite Garantie der MARKTREIFE oder der VERWENDBARKEIT FÜR EINEN BESTIMMTEN ZWECK. Details finden Sie in der GNU General Public License. Sie sollten ein Exemplar der GNU General Public License zusammen mit diesem Programm erhalten haben. Falls nicht, finden Sie ein Exemplar der GNU General Public License zu diesem Programm hier:  <http://www.gnu.org/licenses/>. This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or (at your option) any later version. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details. You should have received a copy of the GNU General Public License along with this program; if not, see <http://www.gnu.org/licenses/>.\n\n-- Parameter, Settings\n--- site_id: ID der Schnittstelle des SolarEdge-Wechselrichters\n--- api_key: Zugriffschlüssel für die SolarEdge-Schnittstelle\n--- interval: Zeitintervall für die Abfrage der Betriebsdaten\n--- wait: yes/no, der Adapter geht mit \"yes\" in den Wartezustand\n--- globaleValues: yes/no, der Adapter speichert mit \"yes\" die Betriebsdaten zusätzlich im Bereich der globalen Variablen ab, dafür sind die Globalen Variablen dort manuell einzurichten.\n\n-- Init seAdapter\nfunction QuickApp:onInit()\n    self:debug(\"onInit\")\n    self.http = net.HTTPClient({timeout=10000})\n    self:Update(\"Start seAdapter1\")\nend\n-- Datenabfrage im Zyklus\nfunction QuickApp:Update(message)   \n    self.looptime = tonumber(self:getVariable(\"interval\"))*1000 -- 60*1000= rd. 60 sec = 1 Minute\n    self:debug(\"looptime= \", self.looptime)\n    self.wait = self:getVariable(\"wait\")\n    self.setGlobalValues = self:getVariable(\"globalvalues\")\n    self.go = \"true\" \n    -- Check the Start-Values \"interval\", \"wait\" \n    if  (self.looptime == 0) or (self.looptime <= 30) then\n    self:warning(\"seAdapter, error Interval value!\") -- Value \"interval\"= 0 or <=30\n    self.go = \"false\"\n    end\n    if  (self.wait ~= \"no\") then\n        self:trace(\"seAdapter is waiting!\") -- Value \"wait\"=yes\n        self.go = \"false\"\n    end\n    -- to data request\n    if (self.go == \"true\") then\n        self:debug(\"start data request seAdapter\")\n    -- Daten der SolarEdge-API lesen\n    local address = \"https://monitoringapi.solaredge.com/site/\"..self:getVariable(\"site_id\")..\"/overview.json?api_key=\"..self:getVariable(\"api_key\")\n    self:debug(address)\n    self.http:request(address, {\n        options={\n            headers = { \n                Accept = \"application/json\"\n            },\n            method = 'GET'\n        },\n        success = function(response)\n                self:debug(\"response status:\", response.status) \n                self:debug(\"headers:\", response.headers[\"Content-Type\"]) \n                local sedata = json.decode(response.data)\n                \n                -- prepare data           \n                local timestamp = sedata.overview.lastUpdateTime\n\n                local currpower = sedata.overview.currentPower.power\n                currpower = currpower/1000\n                currpower = string.format(\"%.2f\", currpower)\n            \n                local dayenergy = sedata.overview.lastDayData.energy\n\t\t\t    dayenergy = dayenergy/1000\n                dayenergy = string.format(\"%.2f\", dayenergy)\n            \n                local monthenergy = sedata.overview.lastMonthData.energy\n                monthenergy = monthenergy/1000\n                monthenergy = string.format(\"%.2f\", monthenergy)\n            \n                local yearenergy = sedata.overview.lastYearData.energy\n\t\t\t    yearenergy = yearenergy/1000\n                yearenergy = string.format(\"%.2f\", yearenergy)\n            \n                local lifetimeenergy = sedata.overview.lifeTimeData.energy\n\t\t\t    lifetimeenergy = lifetimeenergy/1000\n                lifetimeenergy = string.format(\"%.2f\", lifetimeenergy)\n\n                local moneylifetime = sedata.overview.lifeTimeData.revenue\n                moneylifetime = string.format(\"%.2f\", moneylifetime)\n            \n                -- Prepare Values to display\n                local Vtimestamp = \"Letzte Messung: \" ..timestamp..\"\"\n                self:debug(Vtimestamp)\n                self:updateView(\"LME\", \"text\", Vtimestamp)\n\n                local VcurrPower = \"Erzeugung aktuell: \" ..currpower..\" kW\"\n                self:debug(VcurrPower)\n                self:updateView(\"CPE\", \"text\", VcurrPower)\n\n                local Vtoday = \"Energie heute: \" ..dayenergy..\" kWh\"\n                self:debug(Vtoday)\n                self:updateView(\"TPE\", \"text\", Vtoday)\n\n                local VMonth = \"Energie diesen Monat: \" ..monthenergy..\" kWh\"\n                self:debug(VMonth)\n                self:updateView(\"MPE\", \"text\", VMonth)\n\n                local VYear = \"Energie dieses Jahr: \" ..yearenergy..\" kWh\"\n                self:debug(VYear)\n                self:updateView(\"YPE\", \"text\", VYear)\n\n                local VLifetime = \"Energie Gesamt: \" ..lifetimeenergy..\" kWh\"\n                self:debug(VLifetime)\n                self:updateView(\"LTE\", \"text\", VLifetime)\n\n                local VMoneyLifetime = \"Einnahmen Gesamt: \" ..moneylifetime..\" Euro\"\n                self:debug(VMoneyLifetime)\n                self:updateView(\"LTM\", \"text\", VMoneyLifetime)\n\n                -- Schreiben Globaler Variablen in zentrale Variablenverwaltung\n                if  (self.setGlobalValues ~= \"no\") then\n                    fibaro.setGlobalVariable(\"seTimeStamp\", timestamp)\n                    fibaro.setGlobalVariable(\"sePowerCurrent\", currpower)\n                    fibaro.setGlobalVariable(\"seEnergyDay\", dayenergy)\n                    fibaro.setGlobalVariable(\"seEnergyMonth\", monthenergy)\n                    fibaro.setGlobalVariable(\"seEnergyYear\", yearenergy)\n                    fibaro.setGlobalVariable(\"seEnergyLifetime\", lifetimeenergy)\n                    fibaro.setGlobalVariable(\"seMoneyLifetime\", moneylifetime)\n                    self:debug(\"Save Global Values to Fibaro ready\")\n                end\n            end,\n            error = function(error)\n                self:debug('error: ' .. json.encode(error))\n            end\n        })\n    end\n    fibaro.setTimeout(self.looptime, function() \n        self:Update(\"Next update\")\n        end)\nend\n"}]}